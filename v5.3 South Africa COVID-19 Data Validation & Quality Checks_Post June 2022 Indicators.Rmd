---
title: "South Africa COVID-19 Data Validation & Quality Checks-Post June 2022 2022 indicators"
author: "Vanessa Da Costa"
date: "last updated 8/16/2022"
output: html_document 
---

##Purpose:
This code was developed to check the quality of USAID South Africa's COVID-19 indicators
##Checks valid for July 2022 onwards & in this R script: 
Check 1, Check 2, Check 3, Check 4, Check 5, Check 6, Check 8, Check 9a, Check 10, Check 11, Check 12, Check 13

##Step 1: Installing Packages (ONE-TIME STEP)
Install these packages the first time you run R on your computer. You do not need to run these everytime you open R.

```{r}
install.packages("devtools")
install.packages("googledrive")
install.packages("gargle")
install.packages("googlesheets4")
devtools::install_github("USAID-OHA-SI/glamr", build_vignettes = TRUE)
vignette("credential-management", package = "glamr")
install.packages("validate")
install.packages("flextable")
install.packages("plyr")
install.packages("rmarkdown")
install.packages("stringr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("tidyr")
install.packages("readr")
install.packages("readxl")
install.packages("glamr")
install.packages("purrr")
install.packages("data.table")
install.packages("splitstackshape")
install.packages("gophr")
install.packages("keyring")
install.packages("fs")
install.packages("readxl")
install.packages("lubridate")
install.packages("glue")
install.packages("validate")
install.packages("plyr")
install.packages("here")

```

##Step 2: Authenticate Google Drive (ONE-TIME STEP)
```{r}
set_email("vdacosta@usaid.gov")
load_secrets()
#after this step copy and paste into the R profile script and save
#now stored so don't have to authenticate
drive_auth()
gs4_auth()

```

##Step 3: Running Libraries (EVERY TIME STEP)
Run these packages everytime you open R. The code is depedent on these pacakges.

```{r}
library(rmarkdown)
library(stringr)
library(dplyr)
library(tidyverse)
library(tidyr)
library(readr)
library(readxl)
library(glamr)
library(purrr)
library(data.table)
library(splitstackshape)
library(gophr)
library(keyring)
library(fs)
library(readxl)
library(lubridate)
library(glue)
library(validate)
library(plyr)
library(here)
library(googledrive)
library(gargle)
library(googlesheets4)




```
##Step 4: Read in datasets using google drive (EVERY TIME STEP)
This section pulls from the live google sheets that partners update (files must be google sheets, cannot be XLSX file) 
```{r}
#Google Sheet (must be google sheet, cannot be XLSX file) 
#This section pulls from the live google sheets that partners update
ANOVA<-read_sheet(as_sheets_id('1d4O3gZwdD1qglk1FW442sYnoHQ9SBH6V60s09kEQrjs'), sheet = "Tracker v3", guess_max = 10000)

GUIDEHOUSE<-read_sheet(as_sheets_id('1As-AVLcqhduKL0jA-c92D0vlO0gh1wIuumfMzYwNzo0'), sheet = "Tracker v3", guess_max = 10000)

GETF_NEXTMILE<-read_sheet(as_sheets_id('1WHdEzsyelf20N60JoP2ascrKQynDvaOEnfV3SRVcdBA'), sheet = "Tracker v3", guess_max = 10000)

ADAPT_RTC <-read_sheet(as_sheets_id('1k2yDUZk49SRjTq3ceeXzogUw1TnMszjdXGtYJFwW060'), sheet = "RTC_v3", guess_max = 10000)
     
ADAPT_Aurum <-read_sheet(as_sheets_id('1k2yDUZk49SRjTq3ceeXzogUw1TnMszjdXGtYJFwW060'), sheet = "Aurum_v3", guess_max = 10000)

ADAPT_FPD <-read_sheet(as_sheets_id('1k2yDUZk49SRjTq3ceeXzogUw1TnMszjdXGtYJFwW060'), sheet="FPD_v3", guess_max = 10000)

ADAPT_Stellenbosch <-read_sheet(as_sheets_id('1k2yDUZk49SRjTq3ceeXzogUw1TnMszjdXGtYJFwW060'), sheet="Stellenbosch_v3", guess_max = 10000)

ADAPT_Genesis <-read_sheet(as_sheets_id('1k2yDUZk49SRjTq3ceeXzogUw1TnMszjdXGtYJFwW060'), sheet="Genesis_v3", guess_max = 10000)

ADAPT_INTRA <-read_sheet(as_sheets_id('1k2yDUZk49SRjTq3ceeXzogUw1TnMszjdXGtYJFwW060'), sheet="IntraHealth_v3", guess_max = 10000)

     mutate_if(is.logical, as.list) %>% 
   mutate_if(is.list, as.numeric)

ADAPT_IHPS <-read_sheet(as_sheets_id('1k2yDUZk49SRjTq3ceeXzogUw1TnMszjdXGtYJFwW060'), sheet="IHPS_v3", guess_max = 10000)

ADAPT_Qode <-read_sheet(as_sheets_id('1k2yDUZk49SRjTq3ceeXzogUw1TnMszjdXGtYJFwW060'), sheet="Qode_v3", guess_max = 10000)

ADAPT_ReAction <-read_sheet(as_sheets_id('1k2yDUZk49SRjTq3ceeXzogUw1TnMszjdXGtYJFwW060'), sheet="ReAction!_v3", guess_max = 10000) 


ADAPT <-bind_rows(ADAPT_RTC,ADAPT_Aurum, ADAPT_FPD,ADAPT_Genesis,ADAPT_INTRA,
    ADAPT_IHPS,ADAPT_Qode,ADAPT_ReAction,ADAPT_Stellenbosch)


PARTNER_TOOLS <-bind_rows(ANOVA,GUIDEHOUSE, GETF_NEXTMILE, ADAPT) 



```

##Step 5: Restructure dataset so it's long and dates are in correct format
```{r}
df2<- PARTNER_TOOLS %>%  tidyr::gather(`Reporting Date`,`Value`, `31-Jul-22`:`31-Dec-23`) %>% 
  dplyr::mutate(`Reporting Date` =as.character(as.Date(`Reporting Date`, "%d-%b-%y"),"%d-%b-%y"))%>% 
  dplyr::mutate(`Reporting Date` = as.Date(`Reporting Date`,"%d-%b-%y")) %>% 
  #created unique ID so row with errors can be easily identified
  dplyr::mutate(uniqueid=paste(Partner, OrgUnit, `Dataelement Code`, `disagg category`, `Disaggregate`, `Reporting Date`, sep= "_")) %>% 
  dplyr::filter(`Reporting Date` == "2022-07-31" |`Reporting Date` == "2022-06-30") #update this to current and previous reporting month

```

##Step 6: Create data frames for each Level 1 Check and bind together
```{r}
#Dataset to check missing
check1<- df2 %>% 
  dplyr:: mutate(check = ifelse(is.na(Value), "Value is NA", "NO ISSUE")) %>% 
  dplyr::filter(`check`== "Value is NA") %>% 
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(`check_guidance`="Review the 'Value' column") %>% 
  dplyr::mutate(`check_num`="check1")

#Dataset to check 0
check2<- df2 %>% 
  dplyr::mutate(`Value`= as.character(`Value`)) %>%
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(check = ifelse(`Value`==0, "VALUE IS 0", "NO ISSUE")) %>% 
  dplyr::filter(`check`== "VALUE IS 0") %>%
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(`check_guidance`="Review the 'Value' column") %>% 
  dplyr::mutate(`check_num`="check2")

#Bind level 1 checks into 1 dataset
Level1 <-  dplyr::bind_rows(check1, check2)

```

##Step 7: Create data frames for each Level 2 Check
```{r}

#Dataset to check Unknown Sex == Male + Female
check3<- df2 %>% 
  dplyr::filter(`Dataelement Code`== "CV.1.3-3" | `Dataelement Code`== "CV.1.4-6" | `Dataelement Code`== "CV.1.4-7" | `Dataelement Code`==  "CV.1.4-8" | `Dataelement Code`==  "CV.2.1-12"| `Dataelement Code`==  "CV.2.2-13"| `Dataelement Code`==  "CV.2.3-15"| `Dataelement Code`==  "CV.2.4-18"| `Dataelement Code`==  "CV.2.5-20"| `Dataelement Code`==  "CV.1.9-1" | `Dataelement Code`==  "CV.1.9-2"| `Dataelement Code`==  "CV.1.9-3")   %>%
  dplyr::filter (`disagg category`== "Sex") %>% 
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(id3=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`, sep= "_"))%>%
  dplyr::select(-c(uniqueid)) %>% 
  dplyr::group_by(id3,`Disaggregate`) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  tidyr::spread(key=Disaggregate, value=Value) %>% 
  dplyr::mutate(`Reporting Date`= as.character(`Reporting Date`)) %>% 
  dplyr::mutate(`Female`= as.numeric(`Female`)) %>% 
  dplyr::mutate(`Male`= as.numeric(`Male`)) %>%
  dplyr::mutate(`Unknown sex`= as.numeric(`Unknown sex`)) %>%
  dplyr::mutate_at( dplyr::vars("Female"), ~ tidyr::replace_na(.,0)) %>% 
  dplyr::mutate_at( dplyr::vars("Male"), ~   tidyr::replace_na(.,0)) %>% 
  dplyr::mutate_at( dplyr::vars("Unknown sex"), ~tidyr::replace_na(.,0)) %>% 
  dplyr::mutate(F_M_Total= Female + Male) %>% 
  dplyr::mutate(check = ifelse(`Unknown sex`==F_M_Total &`Unknown sex` >0 , "Unknown Sex == Male + Female", "NO ISSUE")) %>% 
 dplyr::filter(`check`== "Unknown Sex == Male + Female") %>% 
  dplyr::mutate(`check_guidance`="Review the 'Unknown Sex'& 'F_M_Total' columns") %>% 
  dplyr::mutate(`check_num`="check3") %>%
  mutate(`Reporting Date` =as.Date(`Reporting Date`, origin="1899-12-30")) %>%  
  dplyr::rename(uniqueid= id3)

#Dataset to check if Sex <> Vaccine brand
check4<- df2 %>% 
  dplyr::filter(`Dataelement Code`== "CV.1.4-6" | `Dataelement Code`== "CV.1.4-7" | `Dataelement Code`==  "CV.1.4-8" | `Dataelement Code`==  "CV.1.9-1" | `Dataelement Code`==  "CV.1.9-2"| `Dataelement Code`==  "CV.1.9-3")   %>% 
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(id4=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`,`disagg category`, sep= "_")) %>% 
  dplyr::select(-c(Disaggregate,uniqueid)) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::group_by(id4) %>% 
  dplyr::mutate(`Value`= sum(`Value`)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(id4_2=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`, sep= "_")) %>%
  dplyr::select(-c(id4)) %>% 
  dplyr::distinct() %>% 
  tidyr::spread(key=`disagg category`, value=Value) %>% 
#  dplyr::mutate_at(vars("Vaccine brand"), ~replace_na(.,0)) %>% 
 # dplyr::mutate_at(vars("Sex"), ~replace_na(.,0)) %>% 
  dplyr::mutate(`Vaccine brand`= as.numeric(`Vaccine brand`)) %>% 
  dplyr::mutate(`Sex`= as.numeric(`Sex`)) %>% 
  dplyr:: mutate(check = ifelse(`Sex`==`Vaccine brand`, "NO ISSUE", "Sex <> Vaccine brand")) %>%
  dplyr::filter(`check`== "Sex <> Vaccine brand") %>% #should the difference be +/- one because right now all errors are only a difference of 1
    dplyr::mutate(`check_guidance`="Review the 'Sex'& 'Vaccine brand' columns") %>% 
  dplyr::mutate(`check_num`="check4") %>% 
  dplyr::rename(uniqueid= id4_2)


#Dataset to check if same value reported for two or more of the disaggregate options
check5 <-df2 %>% 
   dplyr::filter(`Dataelement Code`== "CV.1.3-3" |`Dataelement Code`== "CV.1.4-5" | `Dataelement Code`== "CV.1.4-6" | `Dataelement Code`== "CV.1.4-7" | `Dataelement Code`==  "CV.1.4-8" | `Dataelement Code`==  "CV.2.1-11"|`Dataelement Code`==  "CV.2.1-12"| `Dataelement Code`==  "CV.2.2-13"| `Dataelement Code`==  "CV.2.3-15"| `Dataelement Code`==  "CV.2.4-18"| `Dataelement Code`==  "CV.2.5-20"|`Dataelement Code`==  "CV.2.6-22"| `Dataelement Code`==  "CV.1.9-1" | `Dataelement Code`==  "CV.1.9-2"| `Dataelement Code`==  "CV.1.9-3")    %>%  
   dplyr::mutate(id5=paste(Partner, OrgUnit, `Dataelement Code`, `disagg category`, `Reporting Date`, sep= "_")) %>% 
  dplyr::mutate(`Value`= as.character(`Value`)) %>%
  group_by(id5, Value) %>% 
  dplyr::mutate(
    count = row_number(), # Counts rows by group
    check = count > 1 & Value >"0"    # TRUE if there is more than one row per group & if value doesn't equal 0
  ) %>% 
    dplyr::mutate(`check`= as.character(`check`)) %>%
  mutate(check = recode(check, `TRUE` = 'Value reported in 2+ Disaggregate options', `FALSE` = 'NO ISSUE' )) %>% 
  group_by(id5) %>% 
  dplyr::filter(count== max(count)) %>% 
  distinct(id5,count, .keep_all = TRUE) %>%
  filter(`check`== "Value reported in 2+ Disaggregate options") %>% 
  dplyr::select(-c(uniqueid, count)) %>% 
  dplyr::mutate(`check_guidance`="Review the 'Value' & 'Disaggregate' column- check the other disaggregates in review for corresponding duplicate") %>% 
  dplyr::mutate(`check_num`="check5") %>% 
  dplyr::mutate(`Value`= as.character(`Value`)) %>%
  dplyr::filter(Value != "NULL") %>% 
  dplyr::filter(Value != "NA") %>% 
  dplyr::rename(uniqueid= id5)


#Dataset to check if same value reported for two or more districts or provinces
check6 <-df2 %>% 
    dplyr::filter(`Dataelement Code`== "CV.1.2-2" |`Dataelement Code`== "CV.1.3-3" |`Dataelement Code`== "CV.1.3-4" |`Dataelement Code`== "CV.1.4-5" | `Dataelement Code`== "CV.1.4-6" | `Dataelement Code`== "CV.1.4-7" | `Dataelement Code`==  "CV.1.4-8"| `Dataelement Code`==  "CV.2.2-13"| `Dataelement Code`==  "CV.2.3-15"|  `Dataelement Code`==  "CV.2.4-17"| `Dataelement Code`==  "CV.2.4-18"|  `Dataelement Code`==  "CV.2.5-19" |`Dataelement Code`==  "CV.2.5-20"|`Dataelement Code`==  "CV.2.5-21"| `Dataelement Code`==  "CV.1.9-1" | `Dataelement Code`==  "CV.1.9-2"| `Dataelement Code`==  "CV.1.9-3") %>%   
   dplyr::mutate(id6=paste(`Dataelement Code`, `disagg category`,`Disaggregate`, `Reporting Date`, sep= "_")) %>% 
  dplyr::group_by(id6, Value) %>% 
  dplyr::mutate(
    count = dplyr::row_number(), # Counts rows by group
    check   = count > 1 & Value >"0"   # TRUE if there is more than one row per group
  ) %>%
  dplyr::mutate(`check`= as.character(`check`)) %>%
  dplyr::mutate(check = dplyr::recode(check, `TRUE` = 'Value reported in 2+ District or Province options', `FALSE` = 'NO ISSUE' )) %>% 
  dplyr::group_by(id6) %>% 
  dplyr::filter(count== max(count)) %>% 
  dplyr::distinct(id6,count, .keep_all = TRUE) %>%
  dplyr::filter(`check`== "Value reported in 2+ District or Province options") %>% 
  dplyr::select(-c(uniqueid, count)) %>% 
    dplyr::mutate(`check_guidance`="Review the 'Value' & 'OrgUnit' column- check the other OrgUnit in review for corresponding duplicate") %>% 
  dplyr::mutate(`check_num`="check6") %>% 
  dplyr::mutate(`Value`= as.character(`Value`)) %>%
  dplyr::filter(Value != "NULL") %>% 
  dplyr::filter(Value != "NA") %>% 
  dplyr::rename(uniqueid= id6)


#Dataset to check if same value reported as previous month
check8 <-df2 %>% 
  dplyr::mutate(id8=paste(Partner, OrgUnit, `Dataelement Code`, `disagg category`, `Disaggregate`, sep= "_"))%>%
  dplyr::select(-c(uniqueid)) %>%
  dplyr::mutate(`Value`= as.character(`Value`)) %>%
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::arrange(id8, `Reporting Date`) %>% 
  dplyr::group_by(id8) %>% 
  #create a column for previously reported value
  dplyr::mutate(value_prev_month = dplyr::lag(Value, n =1, default=NA)) %>% 
# filter where the current and previous values are the same
  dplyr::mutate(check = ifelse(value_prev_month==Value & Value >0, "Same Value Reported as Previous Month", "NO ISSUE")) %>% 
  dplyr::filter(`check`== "Same Value Reported as Previous Month") %>%
  dplyr::mutate(`check_guidance`="Review the 'Value' & 'value_prev_month' columns") %>% 
  dplyr::mutate(`check_num`="check8") %>% 
  dplyr::mutate(`Value`= as.character(`Value`)) %>%
  dplyr::mutate(`value_prev_month`= as.character(`value_prev_month`)) %>%
  dplyr::rename(uniqueid= id8)

  
#Dataset to check if value changed from previous month for VACC 0.3 (numeric)
check9a <-df2 %>% 
    dplyr::filter(`Dataelement Code`== "CV.1.3-3" |`Dataelement Code`==  "CV.2.1-12" |`Dataelement Code`==  "CV.2.2-13"| `Dataelement Code`==  "CV.2.3-15"| `Dataelement Code`==  "CV.2.5-20") %>% 
  dplyr::mutate(id9a=paste(Partner, OrgUnit, `Dataelement Code`, `disagg category`, `Disaggregate`, sep= "_"))%>%
  dplyr::mutate(`Value`= as.character(`Value`)) %>%
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::select(-c(uniqueid)) %>%
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::arrange(id9a, `Reporting Date`) %>% 
  dplyr::group_by(id9a) %>% 
  #create a column for previously reported value
  dplyr::mutate(value_prev_month = dplyr::lag(Value, n =1, default=NA)) %>% 
# filter where the current and previous values change
  dplyr::mutate(check = ifelse(value_prev_month!= Value & Value >0, "Change from Previous Month", "NO ISSUE")) %>% 
  dplyr::filter(`check`== "Change from Previous Month") %>% 
  dplyr::mutate(`check_guidance`="Review the 'Value' & 'value_prev_month' columns") %>% 
  dplyr::mutate(`check_num`="check9a") %>% 
  dplyr::mutate(`Value`= as.character(`Value`)) %>%
  dplyr::mutate(`value_prev_month`= as.character(`value_prev_month`)) %>%
  dplyr::rename(uniqueid= id9a)


#Dataset to check if value changed from +/- 50% from previous reported value
check10 <-df2 %>% 
  dplyr::mutate(id10=paste(Partner, OrgUnit, `Dataelement Code`, `disagg category`, `Disaggregate`, sep= "_"))%>%
   dplyr::mutate(`Value`= as.character(`Value`)) %>%
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::select(-c(uniqueid)) %>%
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::arrange(id10, `Reporting Date`) %>% 
  dplyr::group_by(id10) %>% 
  #create a column for previously reported value
  dplyr::mutate(value_prev_month = dplyr::lag(Value, n =1, default=NA)) %>% 
  dplyr::mutate(Percent_change =(Value- value_prev_month)/value_prev_month) %>% 
# filter where the current and previous values change
  dplyr::mutate(check = ifelse(Percent_change>0.5  | Percent_change< -0.5, "+/- 50% Change from Previous Month", "NO ISSUE")) %>% 
  dplyr::filter(`check`== "+/- 50% Change from Previous Month") %>%
  dplyr::mutate(`check_guidance`="Review the'Value'm 'value_prev_month', & 'Percent_change' columns") %>% 
  dplyr::mutate(`check_num`="check10") %>% 
  dplyr::mutate(`Value`= as.character(`Value`)) %>%
  dplyr::mutate(`value_prev_month`= as.character(`value_prev_month`)) %>%
  dplyr::rename(uniqueid= id10)

#Dataset to check if Sex <> Training
check11<- df2 %>% 
  dplyr::filter(`Dataelement Code`==  "CV.2.5-20") %>% 
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(id11=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`,`disagg category`, sep= "_")) %>% 
  dplyr::select(-c(Disaggregate,uniqueid)) %>% 
  dplyr::mutate_at(vars("Value"), ~replace_na(.,0)) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::group_by(id11) %>% 
  dplyr::mutate(`Value`= sum(`Value`)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(id11_2=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`, sep= "_")) %>%
  dplyr::select(-c(id11)) %>% 
  dplyr::distinct() %>% 
  tidyr::spread(key=`disagg category`, value=Value) %>% 
  dplyr::mutate_at(vars("Training"), ~replace_na(.,0)) %>% 
  dplyr::mutate_at(vars("Sex"), ~replace_na(.,0)) %>% 
  dplyr::mutate(`Training`= as.numeric(`Training`)) %>% 
  dplyr::mutate(`Sex`= as.numeric(`Sex`)) %>% 
  dplyr:: mutate(check = ifelse(`Sex`==`Training`, "NO ISSUE", "Sex <> Training")) %>%
    dplyr::filter(`check`== "Sex <> Training") %>%
    dplyr::mutate(`check_guidance`="Review the 'Sex'& 'Training' columns") %>% 
  dplyr::mutate(`check_num`="check11") %>% 
  dplyr::rename(uniqueid= id11_2)

#Dataset to check if Sex <> Work Cadre
check12<- df2 %>% 
  dplyr::filter(`Dataelement Code`==  "CV.2.4-18") %>% 
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(id12=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`,`disagg category`, sep= "_")) %>% 
  dplyr::select(-c(Disaggregate,uniqueid)) %>%
  dplyr::mutate_at(vars("Value"), ~replace_na(.,0)) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::group_by(id12) %>% 
  dplyr::mutate(`Value`= sum(`Value`)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(id12_2=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`, sep= "_")) %>%
  dplyr::select(-c(id12)) %>% 
  dplyr::distinct() %>% 
  tidyr::spread(key=`disagg category`, value=Value) %>% 
  dplyr::mutate_at(vars("Work cadre"), ~replace_na(.,0)) %>% 
  dplyr::mutate_at(vars("Sex"), ~replace_na(.,0)) %>% 
  dplyr::mutate(`Work cadre`= as.numeric(`Work cadre`)) %>% 
  dplyr::mutate(`Sex`= as.numeric(`Sex`)) %>% 
  dplyr:: mutate(check = ifelse(`Sex`==`Work cadre`, "NO ISSUE", "Sex <> Work cadre")) %>%
  dplyr::filter(`check`== "Sex <> Work cadre") %>%
  dplyr::mutate(`check_guidance`="Review the 'Sex'& 'Work cadre' columns") %>% 
  dplyr::mutate(`check_num`="check12") %>% 
  dplyr::rename(uniqueid= id12_2)

#Dataset to check if Severity of event <>Type of USG support
check13<- df2 %>% 
  dplyr::filter(`Dataelement Code`==  "CV.1.5-9") %>% 
  tidyr::unnest(Value) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(id13=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`,`disagg category`, sep= "_")) %>% 
  dplyr::select(-c(Disaggregate,uniqueid)) %>%
  dplyr::mutate_at(vars("Value"), ~replace_na(.,0)) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::group_by(id13) %>% 
  dplyr::mutate(`Value`= sum(`Value`)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(id13_2=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`, sep= "_")) %>%
  dplyr::select(-c(id13)) %>% 
  dplyr::distinct() %>% 
  tidyr::spread(key=`disagg category`, value=Value) %>% 
  dplyr::mutate_at(vars("Severity of event"), ~replace_na(.,0)) %>% 
  dplyr::mutate_at(vars("Type of USG support"), ~replace_na(.,0)) %>% 
  dplyr::mutate(`Severity of event`= as.numeric(`Severity of event`)) %>% 
  dplyr::mutate(`Type of USG support`= as.numeric(`Type of USG support`)) %>% 
  dplyr:: mutate(check = ifelse(`Type of USG support`==`Severity of event`, "NO ISSUE", "Type of USG support <> Severity of event")) %>%
 dplyr::filter(`check`== "Type of USG support <> Severity of event") %>%
  dplyr::mutate(`check_guidance`="Review the 'Type of USG support'& 'Severity of event' columns") %>% 
  dplyr::mutate(`check_num`="check13") %>% 
  dplyr::rename(uniqueid= id13_2)

#Bind level 2 checks into 1 dataset
Level2 <- bind_rows(check3, check4, check5, check6, check8, check9a, check10, check11,check12, check13) 

#where there are flags for July 2022
Level2<-bind_rows(check6)

```

##Step 8: Create separate partner files by level

```{r}
  Level1_ANOVA<-Level1 %>% 
    dplyr::filter(`Partner`== "ANOVA")
  Level2_ANOVA<-Level2 %>% 
    dplyr::filter(`Partner`== "ANOVA")

  Level1_GUIDEHOUSE<-Level1 %>% 
    dplyr::filter(`Partner`== "Guidehouse")
  Level2_GUIDEHOUSE<-Level2 %>% 
    dplyr::filter(`Partner`== "Guidehouse")
  
  Level1_GETF_NEXTMILE<-Level1 %>% 
    dplyr::filter(`Partner`== "GETF")
  Level2_GETF_NEXTMILE<-Level2 %>% 
    dplyr::filter(`Partner`== "GETF")
  
   Level1_ADAPT<-Level1 %>% 
    dplyr::filter(`Partner`== "Right to Care" |`Partner`== "THE AURUM INSTITUTE"|`Partner`== "Foundation for Professional Development (FPD)"|`Partner`== "Genesis Analytics"|`Partner`== "Institute of Health Programs and Systems (IHPS)"|`Partner`== "IntraHealth"|`Partner`== "Qode Health Solutions"|`Partner`== "Re-Action!"|`Partner`== "UNIVERSITEIT STELLENBOSCH")
   Level2_ADAPT<-Level2 %>% 
        dplyr::filter(`Partner`== "Right to Care" |`Partner`== "THE AURUM INSTITUTE"|`Partner`== "Foundation for Professional Development (FPD)"|`Partner`== "Genesis Analytics"|`Partner`== "Institute of Health Programs and Systems (IHPS)"|`Partner`== "IntraHealth"|`Partner`== "Qode Health Solutions"|`Partner`== "Re-Action!"|`Partner`== "UNIVERSITEIT STELLENBOSCH")
```


##Step 9: Save results in existing Excel Workbook on desktop

```{r}
# https://ycphs.github.io/openxlsx/articles/Introduction.html
  
ANOVA_wb<- openxlsx::loadWorkbook("ANOVA_COVID-19 DQRT Tracker.xlsx") 

  openxlsx::writeData(ANOVA_wb, sheet = "Level1", x = Level1_ANOVA, 
          colNames=T, withFilter=T)
  openxlsx::writeData(ANOVA_wb, sheet = "Level2", x = Level2_ANOVA, 
          colNames=T, withFilter=T)
  openxlsx::saveWorkbook(ANOVA_wb, "ANOVA_COVID-19 DQRT Tracker.xlsx", overwrite = TRUE)
  
GUIDEHOUSE_wb<- openxlsx::loadWorkbook("GUIDEHOUSE_COVID-19 DQRT Tracker.xlsx") 
  openxlsx::writeData(GUIDEHOUSE_wb, sheet = "Level1", 
  x = Level1_GUIDEHOUSE, 
  colNames=T, withFilter=T)
  openxlsx::writeData(GUIDEHOUSE_wb, sheet = "Level2", 
  x = Level2_GUIDEHOUSE, 
  colNames=T, withFilter=T)
  openxlsx::saveWorkbook(GUIDEHOUSE_wb, "GUIDEHOUSE_COVID-19 DQRT Tracker.xlsx", overwrite = TRUE)

GETF_NETXTMILE_wb<- openxlsx::loadWorkbook("GETF_COVID-19 DQRT Tracker.xlsx")
  openxlsx::writeData(GETF_NETXTMILE_wb, sheet = "Level1", 
  x =   Level1_GETF_NEXTMILE, 
  colNames=T, withFilter=T)
  openxlsx::writeData(GETF_NETXTMILE_wb, sheet = "Level2", 
  x =   Level2_GETF_NEXTMILE, 
  colNames=T, withFilter=T)
  openxlsx::saveWorkbook(GETF_NETXTMILE_wb, "GETF_COVID-19 DQRT Tracker.xlsx", overwrite = TRUE)
  
ADAPT_wb<- openxlsx::loadWorkbook("ADAPT_COVID-19 DQRT Tracker.xlsx") 
  openxlsx::writeData(ADAPT_wb, sheet = "Level1", 
  x =  Level1_ADAPT, 
  colNames=T, withFilter=T)
  openxlsx::writeData(ADAPT_wb, sheet = "Level2", 
  x =  Level2_ADAPT, 
  colNames=T, withFilter=T)
  openxlsx::saveWorkbook( ADAPT_wb, "ADAPT_COVID-19 DQRT Tracker.xlsx", overwrite = TRUE)

##If need a master file-optional to run
  wb<- openxlsx::loadWorkbook("MASTER_COVID-19 DQRT Tracker.xlsx") 
  openxlsx::writeData(wb, sheet = "Level1", x = Level1, 
          colNames=T, withFilter=T)
  openxlsx::writeData(wb, sheet = "Level2", x = Level2, 
          colNames=T, withFilter=T) 
  openxlsx::saveWorkbook(wb, "MASTER_COVID-19 DQRT Tracker.xlsx", overwrite = TRUE)
  

##If needed To output to master CSV file directly
#write_excel_csv(Level1, paste0("SA_COVID19_LEVEL1_DataVal_DataQual_", format(Sys.time(), "%d-%b-%Y"), ".csv"))
#write_excel_csv(Level2, paste0("SA_COVID19_LEVEL2_DataVal_DataQual_", format(Sys.time(), "%d-%b-%Y"), ".csv"))

```
