---
title: "South Africa COVID-19 Data Validation & Quality Checks""
author: "Vanessa Da Costa"
date: "5/19/2022 NOTE THAT THIS IS STILL IN PORGRESS"
output: html_document 
---

##Purpose:
This code was developed to check the quality of USAID South Africa's COVID-19 indicators

##Step 1: Installing Packages (ONE-TIME STEP)
Install these packages the first time you run R on your computer. You do not need to run these everytime you open R.

```{r}
install.packages("devtools")
install.packages("googledrive")
install.packages("gargle")
install.packages("googlesheets4")
devtools::install_github("USAID-OHA-SI/glamr", build_vignettes = TRUE)
vignette("credential-management", package = "glamr")
install.packages("validate")
install.packages("flextable")
install.packages("plyr")
install.packages("rmarkdown")
install.packages("stringr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("tidyr")
install.packages("readr")
install.packages("readxl")
install.packages("glamr")
install.packages("purrr")
install.packages("data.table")
install.packages("splitstackshape")
install.packages("gophr")
install.packages("keyring")
install.packages("fs")
install.packages("readxl")
install.packages("lubridate")
install.packages("glue")
install.packages("validate")
install.packages("plyr")
install.packages("here")

```

##Step 2: Authenticate Google Drive (ONE-TIME STEP)
```{r}
set_email("vdacosta@usaid.gov")
load_secrets()
#after this step copy and paste into the R profile script and save
#now stored so don't have to authenticate
drive_auth()
gs4_auth()

```

##Step 3: Running Libraries (EVERY TIME STEP)
Run thee packages everytime you open R. The code is depedent on these pacakges.

```{r}
library(rmarkdown)
library(stringr)
library(dplyr)
library(tidyverse)
library(tidyr)
library(readr)
library(readxl)
library(glamr)
library(purrr)
library(data.table)
library(splitstackshape)
library(gophr)
library(keyring)
library(fs)
library(readxl)
library(lubridate)
library(glue)
library(validate)
library(plyr)
library(here)
library(googledrive)
library(gargle)
library(googlesheets4)




```
##Step 4a: Read in dataset using google drive
```{r}
#Google Sheet (must be google sheet, cannot be XLSX file)
ANOVA<-read_sheet(as_sheets_id('1P9QQWbj1xnBC2dkZ9ttWB62kgCaMALbX9itNRxDYfkg'))
#BROADREACH<-read_sheet(as_sheets_id('xx'))
#ADAPT<-read_sheet(as_sheets_id('xx'))
#GUIDEHOUSE<-read_sheet(as_sheets_id('xx'))
#GETF_NEXTMILE<-read_sheet(as_sheets_id('xx'))
#EQUIP<-read_sheet(as_sheets_id('xx'))






```
##Step 4b: Read in dataset using your local drive only if you don't use google drive
```{r}
#LOCAL DRIVE (Only do this step if you are running this code from files directly downloaded to your computer)
here("R/South Africa")
ANOVA<-read_excel("COVID_VAX/TEST_ANOVA USAID ARPA_Global Vax.xlsx", sheet="Tracker")









```

##Step 5a: Restructure dataset using this section for google drive

```{r}
##GOOGLE DRIVE RESTRUCTURING 
df2<- ANOVA %>%  tidyr::gather(`Reporting Date`,`Value`, `31-Oct-21`:`30-Sep-22`) %>%    dplyr::mutate(`Reporting Date` =as.character(as.Date(`Reporting Date`, "%d-%b-%y"),"%d-%b-%y")) %>% 
  dplyr::mutate(`Reporting Date` = as.Date(`Reporting Date`,"%d-%b-%y")) %>% 
  #create unique ID so row with erros can be easily identifed
dplyr::mutate(uniqueid=paste(Partner, OrgUnit, `Dataelement Code`, `disagg category`, `Disaggregate`, `Reporting Date`, sep= "_")) %>% 
  dplyr::filter(`Reporting Date` != "2022-05-31") %>%  #delete this row for may update
  dplyr::filter(`Reporting Date` != "2022-06-30") %>% 
  dplyr::filter(`Reporting Date` != "2022-07-31") %>% 
  dplyr::filter(`Reporting Date` != "2022-08-31") %>%  
  dplyr::filter(`Reporting Date` != "2022-09-30") 


```
##Step 5b: Restructure dataset using this section for your local drive drive

```{r}
##LOCAL DRIVE RESTRUCTURING
#V1: Pivot Data, so dates are long
df2<- ANOVA %>%  gather(`Reporting Date`,`Value`, `44500`:`44834`) %>%  
  mutate(`Reporting Date`= as.numeric(`Reporting Date`)) %>% 
  mutate(`Reporting Date` =as.Date(`Reporting Date`, origin="1899-12-30")) %>%  
  #create unique ID so row with erros can be easily identifed
  mutate(uniqueid=paste(Partner, OrgUnit, `Dataelement Code`, `disagg category`, `Disaggregate`, `Reporting Date`, sep= "_")) %>% 

  filter(`Reporting Date` != "2022-05-31") %>%  #delete this row for may update
  filter(`Reporting Date` != "2022-06-30") %>% 
  filter(`Reporting Date` != "2022-07-31") %>% 
  filter(`Reporting Date` != "2022-08-31") %>%  
  filter(`Reporting Date` != "2022-09-30")   


```
##Step 6: Create data frames for each Level 1 Check

```{r}

#Dataset to check missing
check1<- df2 %>% 
   dplyr::filter(`Dataelement Code`== "VACC_0.1" | `Dataelement Code`== "VACC_0.3" | `Dataelement Code`== "VACC_0.4" |`Dataelement Code`== "VACC_0.6" | `Dataelement Code`==  "VACC_0.8") %>% 
  dplyr:: mutate(check = ifelse(is.na(Value), "Value is NA", "NO ISSUE")) %>% 
  dplyr::filter(`check`== "ERROR") %>% 
  dplyr::mutate(`check_num`="check1")

#Dataset to check 0
check2<- df2 %>% 
  dplyr::filter(`Dataelement Code`== "VACC_0.1" | `Dataelement Code`== "VACC_0.3" | `Dataelement Code`== "VACC_0.4" | `Dataelement Code`== "VACC_0.6") %>% 
  dplyr::mutate(check = ifelse(`Value`==0, "VALUE IS 0", "NO ISSUE")) %>% 
  dplyr::filter(`check`== "VALUE IS 0") %>% 
  dplyr::mutate(`check_num`="check2")

Level1 <-  dplyr::bind_rows(check1, check2)

```

##Step 7: Create data frames for each Level 2 Check
```{r}

#Dataset to check Unknown Sex == Male + Female
check3<- df2 %>% 
  dplyr::filter (`disagg category`== "Sex") %>% 
  dplyr::filter(`Dataelement Code`== "VACC_0.1" | `Dataelement Code`== "VACC_0.3" | `Dataelement Code`== "VACC_0.4")   %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(id3=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`, sep= "_"))%>%
     #dplyr::mutate(`Value`= as.character(`Value`)) %>%
  dplyr::select(-c(uniqueid)) %>% 
  dplyr::group_by(id3,`Disaggregate`) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  tidyr::spread(key=Disaggregate, value=Value) %>% 
   #dplyr::mutate(`Reporting Date`= as.character(`Reporting Date`)) %>% 
  dplyr::mutate(`Female`= as.numeric(`Female`)) %>% 
  dplyr::mutate(`Male`= as.numeric(`Male`)) %>%
  dplyr::mutate(`Unknown sex`= as.numeric(`Unknown sex`)) %>%
  dplyr::mutate_at( dplyr::vars("Female"), ~ tidyr::replace_na(.,0)) %>% 
  dplyr::mutate_at( dplyr::vars("Male"), ~   tidyr::replace_na(.,0)) %>% 
  dplyr::mutate_at( dplyr::vars("Unknown sex"), ~tidyr::replace_na(.,0)) %>% 
  dplyr::mutate(F_M_Total= Female + Male) %>% 
  dplyr::mutate(check = ifelse(`Unknown sex`==F_M_Total &`Unknown sex` >0 , "Unknown Sex == Male + Female", "NO ISSUE")) %>% 
  dplyr::filter(`check`== "Unknown Sex == Male + Female") %>% 
  dplyr::mutate(`check_num`="check3") %>% 
  dplyr::rename(uniqueid= id3)

#Dataset to check if Sex <> Vaccine brand
check4<- df2 %>% 
  dplyr::filter(`Dataelement Code`== "VACC_0.1" |`Dataelement Code`== "VACC_0.4")   %>%
  dplyr::filter(NumDenom != "Denominator") %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::mutate(id4=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`,`disagg category`, sep= "_")) %>% 
  dplyr::select(-c(Disaggregate,uniqueid)) %>% 
  dplyr::mutate(`Value`= as.numeric(`Value`)) %>%
  dplyr::group_by(id4) %>% 
  dplyr::mutate(`Value`= sum(`Value`)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(id4_2=paste(Partner, OrgUnit, `Dataelement Code`, `Reporting Date`, sep= "_")) %>%
  dplyr::select(-c(id4)) %>% 
  dplyr::distinct() %>% 
  tidyr::spread(key=`disagg category`, value=Value) %>% 
  dplyr::mutate_at(vars("Vaccine brand"), ~replace_na(.,0)) %>% 
  dplyr::mutate_at(vars("Sex"), ~replace_na(.,0)) %>% 
  dplyr::mutate(`Vaccine brand`= as.numeric(`Vaccine brand`)) %>% 
  dplyr::mutate(`Sex`= as.numeric(`Sex`)) %>% 
  dplyr:: mutate(check = ifelse(`Sex`==`Vaccine brand`, "NO ISSUE", "Sex <> Vaccine brand")) %>%
  dplyr::filter(`check`== "Sex <> Vaccine brand") %>% #should the difference be +/- one because right now all errors are only a difference of 1
  dplyr::mutate(`check_num`="check4") %>% 
  dplyr::rename(uniqueid= id4_2)


#Dataset to check if same value reported for two or more of the disaggregate options

check5 <-df2 %>% 
  filter(`Dataelement Code`== "VACC_0.1" | `Dataelement Code`== "VACC_0.3" | `Dataelement Code`== "VACC_0.4" | `Dataelement Code`== "VACC_0.6")   %>%  
   dplyr::mutate(id5=paste(Partner, OrgUnit, `Dataelement Code`, `disagg category`, `Reporting Date`, sep= "_")) %>% 
  group_by(id5, Value) %>% 
  dplyr::mutate(
    count = row_number(), # Counts rows by group
    check = count > 1     # TRUE if there is more than one row per group
  ) %>%  #do we need to exclude values of 0 for this check?
    dplyr::mutate(`check`= as.character(`check`)) %>%
  mutate(check = recode(check, `TRUE` = 'Value reported in 2+ Disaggregate options', `FALSE` = 'NO ISSUE' )) %>% 
  group_by(id5) %>% 
  dplyr::filter(count== max(count)) %>% 
  distinct(id5,count, .keep_all = TRUE) %>%
  filter(`check`== "Value reported in 2+ Disaggregate options") %>% 
  dplyr::select(-c(uniqueid, count)) %>% 
  dplyr::mutate(`check_num`="check5") %>% 
  dplyr::rename(uniqueid= id5)


#Dataset to check if same value reported for two or more districts
check6 <-df2 %>% 
  dplyr::filter(`Dataelement Code`== "VACC_0.1" | `Dataelement Code`== "VACC_0.4" | `Dataelement Code`== "VACC_0.6")   %>%  
   dplyr::mutate(id6=paste(`Dataelement Code`, `disagg category`,`Disaggregate`, `Reporting Date`, sep= "_")) %>% 
  dplyr::group_by(id6, Value) %>% 
  dplyr::mutate(
    count = dplyr::row_number(), # Counts rows by group
    check   = count > 1     # TRUE if there is more than one row per group
  ) %>%  #do we need to exclude values of 0 for this check?
  dplyr::mutate(`check`= as.character(`check`)) %>%
  dplyr::mutate(check = dplyr::recode(check, `TRUE` = 'Value reported in 2+ District options', `FALSE` = 'NO ISSUE' )) %>% 
  dplyr::group_by(id6) %>% 
  dplyr::filter(count== max(count)) %>% 
  dplyr::distinct(id6,count, .keep_all = TRUE) %>%
  dplyr::filter(`check`== "Value reported in 2+ District options") %>% 
  dplyr::select(-c(uniqueid, count)) %>% 
  dplyr::mutate(`check_num`="check6") %>% 
  dplyr::rename(uniqueid= id6)

#check7

#check8

#check9

#check10


#mutate(value_prev_month = lag(Value, n = 1))
  #filter(value_prev_month==current_value
#create a column for previously reported value
#check9

Level2 <- bind_rows(check3, check4, check5, check6)


Level2 <- bind_rows(check3, check4, check5, check6, check7, check8, check9, check10) 
```


##Step 8: Save results in Excel Workbook

```{r}
# https://ycphs.github.io/openxlsx/articles/Introduction.html
wb<- openxlsx::loadWorkbook("SA_COVID19_DataVal_DataQual.xlsx")

writeData(wb, sheet = "Level_1_checks", x = Level1, 
          colNames=T, withFilter=T)

writeData(wb, sheet = "Level_2_checks", x = Level2, 
          colNames=T, withFilter=T)

saveWorkbook(wb, "SA_COVID19_DataVal_DataQual.xlsx", overwrite = TRUE)

#https://tcbanalytics.com/2017/01/01/update-google-sheets-via-r-automatically/
#https://googlesheets4.tidyverse.org/index.html
```
